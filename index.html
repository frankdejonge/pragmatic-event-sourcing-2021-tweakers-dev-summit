<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Varela&display=swap" rel="stylesheet">

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/eventsauce.css" id="theme">
        <link rel="stylesheet" href="plugin/prism/prism.css" />

		<!-- Theme used for syntax highlighted code -->
<!--		<link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">-->
	</head>
	<body>
    <div id="script-result" class="hidden">
        <div class="script-result-side"></div>
        <pre id="script-result-output"></pre>
        <div class="script-result-side"></div>
    </div>
    <div id="script-indicator" class="hidden">
        <svg viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g id="Page-1" stroke="none" stroke-width="1" fill="#fff" fill-rule="evenodd">
                <g id="icon-shape">
                    <path d="M0.707106781,10.7071068 L-2.00988464e-13,10 L5.48528137,4.51471863 L6.89949494,5.92893219 L2.82842712,10 L6.89949494,14.0710678 L5.48528137,15.4852814 L0.707106781,10.7071068 Z M19.2928932,10.7071068 L20,10 L14.5147186,4.51471863 L13.1005051,5.92893219 L17.1715729,10 L13.1005051,14.0710678 L14.5147186,15.4852814 L19.2928932,10.7071068 Z" id="Combined-Shape"></path>
                </g>
            </g>
        </svg>
    </div>
<!--    <header id="headers">-->
<!--        <img width="30px" height="30px" src="static/logo.svg"/>-->
<!--        <span class="grow"></span>-->
<!--        <span id="title" class="header__title"></span>-->
<!--        <span class="grow"></span>-->
<!--        <img width="30px" height="30px" src="static/logo.svg"/>-->
<!--    </header>-->
    <div class="reveal">
        <div class="slides">
<!--            <section data-background-image="images/rover.jpg">-->
<!--                <h2 style="color: #fff; text-blink: 1"><br/><br/><br/><br/>Look at a cute dog while you wait.</h2>-->
<!--            </section>-->
            <section>
                <h2>
                    A pragmatic introduction into<br/>
                    Event<span class="text-red">Sourcing</span>
                </h2>
                <h3>with <span class="text-red">Frank</span> de Jonge</h3>
            </section>

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Frank de Jonge</span><br/>
                    Staff Software Engineer at Mollie Payments
                </blockquote>
            </section>

<!--            <section data-background-color="#fff">-->
<!--                <img src="images/mollie.png" alt="Mollie" />-->
<!--                <h3><br/>And yes, we are hiring</h3>-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote>-->
<!--                    <span class="text-rd">EventSourcing</span> is<br/>-->
<!--                    not <span class="text-red">hard</span>, but<br/>-->
<!--                    <span class="text-red">learning</span> it is.<br/>-->
<!--                </blockquote>-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote>-->
<!--                    EventSourcing is a technique where decisions are made based on past events, resulting in newly recorded events that-->
<!--                    are stored for later decisions and broadcast to interested parties so they can <span class="text-red">bla bla bla...</span>-->
<!--                </blockquote>-->
<!--            </section>-->

<!--            <section data-background-image="https://media.giphy.com/media/CiYImHHBivpAs/giphy.gif"></section>-->
<!--            <section data-background-image="https://giphy.com/embed/IzRWsOco0Zp7woExht"></section>-->

<!--            <section data-background-image="images/how-its-made.jpg"></section>-->
<!--            <section data-background-image="https://media.giphy.com/media/IzRWsOco0Zp7woExht/source.gif"></section>-->

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Event Sourcing</span><br/> is a way to create software models using events.
                </blockquote>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-javascript"><code data-trim>
                        $balance = 15;

                        $spendingAmount = 12;

                        if ($spendingAmount >= $balance) {
                            $balance -= $spendingAmount;

                            return true;
                        }
                    </code></pre>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="1" class="language-javascript"><code data-trim>
                        $balance = 15; // context

                        $spendingAmount = 12;

                        if ($spendingAmount >= $balance) {
                            $balance -= $spendingAmount;

                            return true;
                        }
                    </code></pre>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="3" class="language-javascript"><code data-trim>
                        $balance = 15; // context

                        $spendingAmount = 12; // input

                        if ($spendingAmount >= $balance) {
                            $balance -= $spendingAmount;

                            return true;
                        }
                    </code></pre>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="5" class="language-javascript"><code data-trim>
                        $balance = 15; // context

                        $spendingAmount = 12; // input

                        if ($spendingAmount >= $balance) { // decision
                            $balance -= $spendingAmount;

                            return true;
                        }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="6-8" class="language-javascript"><code data-trim>
                        $balance = 15; // context

                        $spendingAmount = 12; // input

                        if ($spendingAmount >= $balance) { // decision
                            $balance -= $spendingAmount; // outcome

                            return true; // outcome
                        }
                    </code></pre>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-javascript"><code data-trim>
                        $balance = 15;

                        $spendingAmount = 12;

                        if ($spendingAmount >= $balance) {
                            $balance -= $spendingAmount;

                            return true;
                        }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="1-2" class="language-javascript"><code data-trim>
                        $transactions = [10, -5, 20, -10];                       // context
                        $balance = foreach ($transactions as $t) $balance += $t; // context
                        $spendingAmount = 12;

                        if ($spendingAmount >= $balance) {
                            $balance -= $spendingAmount;

                            return true;
                        }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="6-8" class="language-javascript"><code data-trim>
                        $transactions = [10, -5, 20, -10];
                        $balance = foreach ($transactions as $t) $balance += $t;
                        $spendingAmount = 12;

                        if ($spendingAmount >= $balance) {
                            $balance -= $spendingAmount;           // outcome
                            $transactions[] = spendingAmount * -1; // outcome
                            return true;                           // outcome
                        }
                    </code></pre>
            </section>

            <section>
                <img src="images/0-state.svg" />
            </section>
            <section>
                <img src="images/1-initial-state.svg" />
            </section>
            <section>
                <img src="images/2-initial-state-action.svg" />
            </section>
            <section>
                <img src="images/3-initial-state-new-state.svg" />
            </section>
            <section>
                <img src="images/4-new-state.svg" />
            </section>
            <section>
                <img src="images/5-old-state-lost.svg" />
            </section>
            <section>
                <img src="images/7-new-state-only.svg" />
            </section>
            <!--            <section>-->
            <!--                <h2>Event<span class="text-red">Sourcing</span></h2>-->
            <!--            </section>-->
            <section>
                <h3>
                    <ol>
                        <li>Load the <span class="text-red">model</span> from the <span class="text-red">database</span>.</li>
                        <li>Interact with the model.</li>
                        <li>Overwrite old <span class="text-red">model</span>.</li>
                    </ol>
                </h3>
            </section>
            <!--            <section>-->
            <!--                <h3>-->
            <!--                    <ol>-->
            <!--                        <li>Rebuild model from stored events.</li>-->
            <!--                        <li>Interact with the model.</li>-->
            <!--                        <li>Store changes in the model.</li>-->
            <!--                    </ol>-->
            <!--                </h3>-->
            <!--                <h4 style="margin-left: -2em;">(Event Sourcing)</h4>-->
            <!--            </section>-->
            <section>
                <h3>
                    <ol>
                        <li>Rebuild the model from <span class="text-red">old&nbsp;events</span>.</li>
                        <li>Interact with the model.</li>
                        <li>Record <span class="text-red">new events</span>.</li>
                    </ol>
                </h3>
            </section>

            <section>
                <img src="images/8-state.svg" />
            </section>
            <section>
                <img src="images/9-perform-an-action.svg" />
            </section>
            <section>
                <img src="images/10-results-in-event.svg" />
            </section>
            <section>
                <img src="images/11-event-is-stored.svg" />
            </section>
            <section>
                <img src="images/12-and-repeat.svg" />
            </section>
            <section>
                <img src="images/13-event-2.svg" />
            </section>
            <section>
                <img src="images/14-event-3.svg" />
            </section>

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote class="smaller">-->
<!--                    <span class="text-white">Event</span>-->
<!--                    <span class="text-white">Aggregate Root</span>-->
<!--                    <span class="text-white">Aggregate Root Repository</span>-->
<!--                    <span class="text-white">Message</span>-->
<!--                    <span class="text-white">Message Repository</span>-->
<!--                    <span class="text-white">Message Dispatcher</span>-->
<!--                    <span class="text-white">Consumer(s)</span>-->
<!--                    <span class="text-white">Projection(s)</span>-->
<!--                    <span class="text-white">Read Model(s)</span>-->
<!--                    <span class="text-white">Process Manager(s)</span>-->
<!--                </blockquote>-->
<!--                <aside class="notes">-->
<!--                    <p>Talk is cheap, let's look at some code.</p>-->
<!--                </aside>-->
<!--            </section>-->

            <!--<section data-title-hidden data-background-color="#fff">-->
            <!--<pre data-line="1" class="language-php"><code data-include="fetch_credit.php" data-filename="transaction-3.php" data-trim>-->
            <!--$credit = fetch_credit();-->
            <!--echo "Credit is $credit\n";-->
            <!--$purchase = amount_from_request();-->

            <!--if ($credit >= $purchase) {-->
            <!--echo "Purchase of $purchase is OK!";-->
            <!--} else {-->
            <!--echo "Purchase of $purchase has failed.";-->
            <!--}-->
            <!--</code></pre>-->
            <!--</section>-->
            <!--<section data-title-hidden data-background-color="#fff">-->
            <!--<pre class="language-php"><code data-filename="fetch_credit_random.php" data-trim>-->
            <!--function fetch_credit() {-->
            <!--// load value from the DB-->
            <!--return rand(60, 100);-->
            <!--}-->

            <!--var_dump(fetch_credit());-->
            <!--</code></pre>-->
            <!--</section>-->
            <!--<section>-->
            <!--<h3>Entity Models</h3>-->
            <!--<h4>(Eloquent / Doctrine)</h4>-->
            <!--</section>-->
<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-filename="entity_models.php" data-trim>-->
<!--                        class PersonalBudget {-->
<!--                            public function __construct(private int $credit) {}-->

<!--                            public function spend(int $amount): bool {-->
<!--                                if ($amount > $this->credit) {-->
<!--                                    return false;-->
<!--                                }-->

<!--                                $this->credit -= $amount;-->

<!--                                return true;-->
<!--                            }-->
<!--                        }-->
<!--                    </code></pre>-->
<!--            </section>-->
<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-include="bank_entity_repository.php" data-filename="entity_usage.php" data-trim>-->
<!--                        $personalBudget = $repository->retrieve($id);-->

<!--                        if ($personalBudget->spend(amount_to_spend())) {-->
<!--                            echo "Spending succeeded";-->
<!--                        } else {-->
<!--                            echo "Spending failed";-->
<!--                        }-->

<!--                        $repository->persist($personalBudget);-->
<!--                    </code></pre>-->
<!--            </section>-->
<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre data-line="1" class="language-php"><code data-include="bank_entity_repository.php" data-filename="entity_usage.php" data-trim>-->
<!--                        $personalBudget = $repository->retrieve($id); // context-->

<!--                        if ($personalBudget->spend(amount_to_spend())) {-->
<!--                            echo "Spending succeeded";-->
<!--                        } else {-->
<!--                            echo "Spending failed";-->
<!--                        }-->

<!--                        $repository->persist($personalBudget);-->
<!--                    </code></pre>-->
<!--            </section>-->
<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre data-line="3,5,7" class="language-php"><code data-include="bank_entity_repository.php" data-filename="entity_usage.php" data-trim>-->
<!--                        $personalBudget = $repository->retrieve($id);-->

<!--                        if ($personalBudget->spend(amount_to_spend())) { // decision-->
<!--                            echo "Spending succeeded";-->
<!--                        } else {-->
<!--                            echo "Spending failed";-->
<!--                        }-->

<!--                        $repository->persist($personalBudget);-->
<!--                    </code></pre>-->
<!--            </section>-->
<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre data-line="4,6,9" class="language-php"><code data-include="bank_entity_repository.php" data-filename="entity_usage.php" data-trim>-->
<!--                        $personalBudget = $repository->retrieve($id);-->

<!--                        if ($personalBudget->spend(amount_to_spend())) {-->
<!--                            echo "Spending succeeded";-->
<!--                        } else {-->
<!--                            echo "Spending failed";-->
<!--                        }-->

<!--                        $repository->persist($personalBudget); // outcome-->
<!--                    </code></pre>-->
<!--            </section>-->

            <section data-background-color="#3d4852">
                <img src="images/lingo.png" alt="">
            </section>





            <!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-trim>-->
<!--                        $personalBudget = $repository->retrieve($id);-->

<!--                        if ($personalBudget->spend(amount_to_spend())) {-->
<!--                            echo "Spending succeeded";-->
<!--                        } else {-->
<!--                            echo "Spending failed";-->
<!--                        }-->

<!--                        $repository->persist($personalBudget);-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote class="smaller">-->
<!--                    <span class="text-white">Event</span>-->
<!--                    <span class="text-white">Aggregate (Root)</span>-->
<!--                    <span class="text-white">Aggregate Root Repository</span>-->
<!--                    <span class="text-white">Message</span>-->
<!--                    <span class="text-white">Message Repository</span>-->
<!--                    <span class="text-white">Message Dispatcher</span>-->
<!--                    <span class="text-white">Consumer(s)</span>-->
<!--                    <span class="text-white">Projection(s)</span>-->
<!--                    <span class="text-white">Read Model(s)</span>-->
<!--                    <span class="text-white">Process Manager(s)</span>-->
<!--                </blockquote>-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote class="smaller">-->
<!--                    <span class="text-red">Event</span>-->
<!--                    <span class="text-red">Aggregate (Root)</span>-->
<!--                    <span class="text-red">Aggregate Root Repository</span>-->
<!--                    <span class="text-white">Message</span>-->
<!--                    <span class="text-white">Message Repository</span>-->
<!--                    <span class="text-white">Message Dispatcher</span>-->
<!--                    <span class="text-white">Consumer(s)</span>-->
<!--                    <span class="text-white">Projection(s)</span>-->
<!--                    <span class="text-white">Read Model(s)</span>-->
<!--                    <span class="text-white">Process Manager(s)</span>-->
<!--                </blockquote>-->
<!--            </section>-->

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Event</span><br/>
                    a representation of a historical fact; something that happened
                    in the past.
                </blockquote>
            </section>

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote>-->
<!--                    <span class="text-red">Event</span><br/>-->
<!--                    an immutable value-object<br/><br/>-->
<!--                </blockquote>-->
<!--            </section>-->

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
                    class PurchaseWasMade
                    {
                        public function __construct(private int $amount)
                        {

                        }

                        public function amount(): int {
                            return $this->amount;
                        }
                    }
                    </code></pre>
                    <aside class="notes">
                        <p></p>
                    </aside>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
                    class PurchaseWasMade
                    {
                        public function toPayload(): array
                        {
                            // serialize to scalars
                        }
                        public static function toPayload(array $payload): PurchaseWasMade
                        {
                            // unserialize from scalars
                        }
                    }
                    </code></pre>
        </section>

<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-trim>-->
<!--                    class PurchaseWasMade-->
<!--                    {-->
<!--                        // ...-->

<!--                        public function toPayload(): array {-->
<!--                            return ['amount' => $this->amount];-->
<!--                        }-->

<!--                        public static function fromPayload(array $payload) {-->
<!--                            return new static($payload['amount']);-->
<!--                        }-->
<!--                    }-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-include="purchase_was_made.php" data-filename="serialize_event.php" data-trim>-->
<!--                        $event1 = new PurchaseWasMade(150);-->

<!--                        $payload = $event1->toPayload();-->

<!--                        $event2 = PurchaseWasMade::fromPayload($payload);-->

<!--                        var_dump('same', $event1 === $event2);-->

<!--                        var_dump('equal', $event1 == $event2);-->
<!--                    </code></pre>-->
<!--            </section>-->

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Aggregate Root</span><br/>
                    encapsulates behaviour, and ensures internal consistency
                </blockquote>
            </section>
            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Aggregate Root</span><br/>
                    you steer a car by turning the steer, not by adjusting the wheels
                </blockquote>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
        class PersonalBudget
        {
            private $budget = 0;

            public function depositFunds(int $amount): void
            {
                // traditional CRUD
                $this->budget += $amount;
            }



        }
                    </code></pre>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
        class PersonalBudget
        {
            // ...

            public function depositFunds(int $amount): void
            {
                // event sourced
                $this->recordThat(new BudgetWasIncreased($amount));
            }



        }
                    </code></pre>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudget
{
    // ...

    protected function recordThat(object $event): void
    {
        $this->recordedEvents[] = $event;
        $this->apply($event);
    }



}
                    </code></pre>
            </section>

<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-trim>-->
<!--class PersonalBudget-->
<!--{-->
<!--    // ...-->

<!--    protected function apply(object $event)-->
<!--    {-->
<!--        $parts = explode('\\', get_class($event));-->
<!--        $this->{'apply' . end($parts)}($event);-->
<!--    }-->





<!--}-->
<!--                    </code></pre>-->
<!--            </section>-->
            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudget
{
    // ...

    protected function applyBudgetWasIncreased(
        BudgetWasIncreased $event
    ) {
        $this->budget += $event->amount();
    }



}
                    </code></pre>
            </section>
            <!--<section data-background-color="#fff">-->
            <!--<img src="images/apply-event.gif" alt="">-->
            <!--</section>-->

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudget
{
    public function spend(int $amount)
    {
        if ($this->budget < $amount) {
            return false;
        }

        $this->budget -= $amount;

        return true;
    }
}
                    </code></pre>
            </section>
            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudget
{
    public function spend(int $amount)
    {
        if ($this->budget < $amount) {
            return false;
        }

        $this->recordThat(new PurchaseWasMade($amount));

        return true;
    }
}
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudget
{
    // ...

    protected function applyPurchaseWasMade(
        BudgetWasIncreased $event
    ) {
        $this->budget -= $event->amount();
    }



}
                    </code></pre>
            </section>

            <section>
                <h3>
                    <ol>
                        <li>Guard business rules</li>
                        <li>Record event</li>
                        <li>Apply (internal update)</li>
                    </ol>
                </h3>
            </section>

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Aggregate Root Repository</span><br/>
                    Storing and retrieving event-sourced models.
                </blockquote>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="3" class="language-php"><code data-trim>
interface AggregateRootRepository
{
    public function persist(object $aggregateRoot);

    public function retrieve(AggregateRootId id): object;
}
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="5" class="language-php"><code data-trim>
                        class PersonalBudgetRepository implements AggregateRootRepository
                        {
                            public function persist(AggregateRoot $aggregate)
                            {
                                $events = $aggregate->releaseEvents();
                                $aggregateRootId = $aggregate->aggregateRootId();








                            }
                        }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="8-11" data- class="language-php"><code data-trim>
                        class PersonalBudgetRepository implements AggregateRootRepository
                        {
                            public function persist(AggregateRoot $aggregate)
                            {
                                $events = $aggregate->releaseEvents();
                                $aggregateRootId = $aggregate->aggregateRootId();

                                $headers = [Header::AGGREGATE_ROOT_ID => $aggregateRootId];
                                $messages = array_map(function (object $event) use ($headers) {
                                    return new Message($event, $headers);
                                }, $events);



                            }
                        }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="13" class="language-php"><code data-trim>
                        class PersonalBudgetRepository implements AggregateRootRepository
                        {
                            public function persist(AggregateRoot $aggregate)
                            {
                                $events = $aggregate->releaseEvents();
                                $aggregateRootId = $aggregate->aggregateRootId();

                                $headers = [Header::AGGREGATE_ROOT_ID => $aggregateRootId];
                                $messages = array_map(function (object $event) use ($headers) {
                                    return new Message($event, $headers);
                                }, $events);

                                $this->messages->persist(...$messages);
                                $this->dispatcher->dispatch(...$messages);
                            }
                        }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
                        class PersonalBudgetRepository implements AggregateRootRepository
                        {
                            public function persist(AggregateRoot $aggregate)
                            {
                                // Get the events from the Aggregate Root
                                // ...

                                // Turn the events into messages
                                // ...
                                // ...
                                // ...

                                // Persist the events in storage
                                // Dispatch the events to consumers
                            }
                        }
                    </code></pre>
            </section>

<!--            <section>-->
<!--                <img src="images/aggregate-to-messages.png" alt="">-->
<!--            </section>-->
<!--            <section>-->
<!--                <img src="images/aggregate-to-messages-1.png" alt="">-->
<!--            </section>-->
<!--            <section>-->
<!--                <img src="images/aggregate-to-messages-2.png" alt="">-->
<!--            </section>-->
<!--            <section>-->
<!--                <img src="images/aggregate-to-messages-3.png" alt="">-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote class="smaller">-->
<!--                    <span class="text-red">Event</span>-->
<!--                    <span class="text-red">Aggregate (Root)</span>-->
<!--                    <span class="text-red">Aggregate Root Repository</span>-->
<!--                    <span class="text-white">Message</span>-->
<!--                    <span class="text-white">Message Repository</span>-->
<!--                    <span class="text-white">Message Dispatcher</span>-->
<!--                    <span class="text-white">Consumer(s)</span>-->
<!--                    <span class="text-white">Projection(s)</span>-->
<!--                    <span class="text-white">Read Model(s)</span>-->
<!--                    <span class="text-white">Process Manager(s)</span>-->
<!--                </blockquote>-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote class="smaller">-->
<!--                    <span class="text-white">Event</span>-->
<!--                    <span class="text-white">Aggregate (Root)</span>-->
<!--                    <span class="text-white">Aggregate Root Repository</span>-->
<!--                    <span class="text-red">Message</span>-->
<!--                    <span class="text-red">Message Repository</span>-->
<!--                    <span class="text-red">Message Dispatcher</span>-->
<!--                    <span class="text-white">Consumer(s)</span>-->
<!--                    <span class="text-white">Projection(s)</span>-->
<!--                    <span class="text-white">Read Model(s)</span>-->
<!--                    <span class="text-white">Process Manager(s)</span>-->
<!--                </blockquote>-->
<!--            </section>-->
            <!--<section>-->
            <!--<img src="images/aggregate-to-messages-4.png" alt="">-->
            <!--</section>-->

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Message</span><br/>
                    a wrapper for an event containing additional metadata (aggregate id, event type, etc)
                </blockquote>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class Message
{
    public function __construct(
        private object $event,
        private array $headers = []
    ) {}

    // ... plus some getters
}
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-json"><code data-trim>
                    {
                        "headers" {
                            "aggregate_root_id": "4d975448-d12b-4a2e-bea4-13efd557bd6e",
                            "event_type": "some_company.namespace.purchase_was_made",
                            "caused_by": "3cf01840-3d50-4658-b953-b71f66ab4701"
                        },
                        "payload": {
                            "amount": 80
                        }
                    }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-sql"><code data-trim>
CREATE TABLE processing_payments (
    `event_id` BINARY(16) NOT NULL,          // UUID
    `aggregate_root_id` BINARY(16) NOT NULL, // UUID
    `version` int(20) unsigned NULL,         // INT
    `payload` varchar(16001) NOT NULL,       // JSON
    PRIMARY KEY (`event_id`),
    KEY (`aggregate_root_id`),
    KEY `reconstitution` (`aggregate_root_id`, `version` ASC)
);
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-sql"><code data-trim>
INSERT INTO your_table_name
    (event_id, aggregate_root_id, version, payload)
    VALUES (:event_id, :aggregate_root_id, :version, :payload)


SELECT payload
    FROM your_table_name
    WHERE aggregate_root_id = :aggregate_root_id
    ORDER BY version ASC

                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="5" class="language-php"><code data-trim>
interface AggregateRootRepository
{
    public function persist(object $aggregateRoot);

    public function retrieve(AggregateRootId id): object;
}
                    </code></pre>
            </section>

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Reconstitution<br/></span>
                    the act of building something up again.<br/>
                </blockquote>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudgetRepository implements AggregateRootRepository
{
    public function retrieve(AggregateRootId $id): PersonalBudget
    {
        return PersonalBudget::reconstituteFromEvents(
            $id,
            $this->retrieveAllEvents($id)
        );
    }



}
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudgetRepository implements AggregateRootRepository
{
    private function retrieveAllEvents(AggregateRootId $id): Generator
    {
        foreach ($this->messages->retrieveAllMessages($id) as $msg) {
            yield $msg->event();
        }
    }




}
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
class PersonalBudget
{
    public static function reconstituteFromEvents(
        Identifier $id,
        Generator $events
    ): PersonalBudget
    {
        $budget = new PersonalBudget($id);
        foreach ($events as $event) $budget->apply($event);

        return $budget;
    }
}
                    </code></pre>
            </section>

            <section>
                <img src="images/reconstitution.png">
            </section>

            <section>
                <img src="images/recording-events.png">
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre data-line="14" class="language-php"><code data-trim>
                        class PersonalBudgetRepository implements AggregateRootRepository
                        {
                            public function persist(AggregateRoot $aggregate)
                            {
                                $events = $aggregate->releaseEvents();
                                $aggregateRootId = $aggregate->aggregateRootId();

                                $headers = [Header::AGGREGATE_ROOT_ID => $aggregateRootId];
                                $messages = array_map(function (object $event) use ($headers) {
                                    return new Message($event, $headers);
                                }, $events);

                                $this->messages->persist(...$messages);
                                $this->dispatcher->dispatch(...$messages);
                            }
                        }
                    </code></pre>
            </section>

            <section data-title-hidden data-background-color="#fff">
                <h4>Dispatch the messages</h4>
                <pre class="language-php"><code data-trim>
                    interface MessageDispatcher
                    {
                        public function dispatch(Message ...$messages);


                    }</code></pre>
                <h5><br/>RabbitMQ / Kafka / InSync / PubSub</h5>
            </section>
<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-trim>-->
<!--class SynchronousMessageDispatcher implements MessageDispatcher-->
<!--{-->
<!--    public function __construct(private Consumer ...$consumers) {}-->

<!--    public function dispatch(Message ...$messages)-->
<!--    {-->
<!--        foreach ($messages as $message) {-->
<!--            foreach ($this->consumers as $consumer) {-->
<!--                $consumer->handle($message);-->
<!--            }-->
<!--        }-->
<!--    }-->
<!--}-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote class="smaller">-->
<!--                    <span class="text-white">Event</span>-->
<!--                    <span class="text-white">Aggregate (Root)</span>-->
<!--                    <span class="text-white">Aggregate Root Repository</span>-->
<!--                    <span class="text-red">Message</span>-->
<!--                    <span class="text-red">Message Repository</span>-->
<!--                    <span class="text-red">Message Dispatcher</span>-->
<!--                    <span class="text-white">Consumer(s)</span>-->
<!--                    <span class="text-white">Projection(s)</span>-->
<!--                    <span class="text-white">Read Model(s)</span>-->
<!--                    <span class="text-white">Process Manager(s)</span>-->
<!--                </blockquote>-->
<!--            </section>-->

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote class="smaller">-->
<!--                    <span class="text-white">Event</span>-->
<!--                    <span class="text-white">Aggregate (Root)</span>-->
<!--                    <span class="text-white">Aggregate Root Repository</span>-->
<!--                    <span class="text-white">Message</span>-->
<!--                    <span class="text-white">Message Repository</span>-->
<!--                    <span class="text-white">Message Dispatcher</span>-->
<!--                    <span class="text-red">Consumer(s)</span>-->
<!--                    <span class="text-red">Projection(s)</span>-->
<!--                    <span class="text-red">Read Model(s)</span>-->
<!--                    <span class="text-red">Process Manager(s)</span>-->
<!--                </blockquote>-->
<!--            </section>-->

            <section data-title-hidden data-background-color="#fff">
                <h4>Respond to the messages</h4>
                <pre class="language-php"><code data-trim>
                    interface MessageConsumer
                    {
                        public function handle(Message $message);


                    }
                </code></pre>
                <h5><br/>Projection / Process Manager</h5>
            </section>

            <section>
                <img src="images/15-series-of-events.svg" alt="">
            </section>
            <section>
                <img src="images/18-even-more-events.svg" alt="">
            </section>
            <section>
                <img src="images/19-projection-1.svg" alt="">
            </section>
            <section>
                <img src="images/20-projection-2.svg" alt="">
            </section>
            <section>
                <img src="images/21-projection-3.svg" alt="">
            </section>

            <section data-title-hidden data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
                class MostSpentList implements MessageConsumer
                {
                    public function handle(Message $message)
                    {
                        $event = $message->event();

                        if ($event instanceof PurchaseWasMade) {
                            $this->spentPerUser->increase(
                                $message->aggregateRootId(),
                                $event->amount()
                            );
                        }
                    }
                }
                    </code></pre>
            </section>

            <section data-background-color="#fff">
                <h3>Consequences</h3>
                <blockquote>
                    ❌ No implicit view<br/>
                    ❌ Separate setup required<br/>
                    ✅ Views are independent<br/>
                    ✅ Views are very simple<br/>
                    ✅ Use any type of DB<br/>
                </blockquote>
            </section>

<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre data-line="1" class="language-php"><code data-trim>-->
<!--                        $personalBudget = $repository->retrieve($id);-->

<!--                        if ($personalBudget->spend(amount_to_spend())) {-->
<!--                            echo "Spending succeeded";-->
<!--                        } else {-->
<!--                            echo "Spending failed";-->
<!--                        }-->

<!--                        $repository->persist($personalBudget);-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-title-hidden data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-include="bank_entity_repository.php" data-filename="entity_usage.php" data-trim>-->
<!--                        $personalBudget = $repository->retrieve($id);-->

<!--                        if ($personalBudget->spend(amount_to_spend())) {-->
<!--                            echo "Spending succeeded";-->
<!--                        } else {-->
<!--                            echo "Spending failed";-->
<!--                        }-->

<!--                        $repository->persist($personalBudget);-->
<!--                    </code></pre>-->
<!--            </section>-->

            <section>
                <h3 class="text-left">
                    Given a <span class="text-red">context</span>,<br/>
                    when handling <span class="text-red">input</span><br/>
                    a <span class="text-red">decision</span> is made<br/>
                    which has an <span class="text-red">outcome</span>.
                </h3>
            </section>

<!--            <section>-->
<!--                <h2>How about <span class="text-red">tests</span>?</h2>-->
<!--            </section>-->

<!--            <section data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-include="spend_150_includes.php" data-filename="spend_150.php" data-trim>-->
<!--                        $messageRepository = new InMemoryMessageRepository();-->
<!--                        $aggregateRootRepository = new AggregateRootRepository(-->
<!--                            PersonalBudget::class,-->
<!--                            $messageRepository-->
<!--                        );-->

<!--                        $id = AggregateRootId::create();-->
<!--                        $headers = [Header::AGGREGATE_ROOT_ID => $id];-->
<!--                        $messageRepository->persist(-->
<!--                            new Message(new BudgetWasIncreased(100), $headers)-->
<!--                        );-->

<!--                        $budget = $aggregateRootRepository->retrieve($id);-->

<!--                        $budget->spend(150);-->

<!--                        $aggregateRootRepository->persist($budget);-->
<!--                        var_dump($messageRepository->lastCommit());-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#fff">-->
<!--                    <pre data-line="1-5" class="language-php"><code data-include="spend_150_includes.php" data-filename="spend_150.php" data-trim>-->
<!--                        $messageRepository = new InMemoryMessageRepository();-->
<!--                        $aggregateRootRepository = new AggregateRootRepository(-->
<!--                            PersonalBudget::class,-->
<!--                            $messageRepository-->
<!--                        );-->

<!--                        $id = AggregateRootId::create();-->
<!--                        $headers = [Header::AGGREGATE_ROOT_ID => $id];-->
<!--                        $messageRepository->persist(-->
<!--                            new Message(new BudgetWasIncreased(100), $headers)-->
<!--                        );-->

<!--                        $budget = $aggregateRootRepository->retrieve($id);-->

<!--                        $budget->spend(150);-->

<!--                        $aggregateRootRepository->persist($budget);-->
<!--                        var_dump($messageRepository->lastCommit());-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#fff">-->
<!--                    <pre data-line="7-11" class="language-php"><code data-include="spend_150_includes.php" data-filename="spend_150.php" data-trim>-->
<!--                        $messageRepository = new InMemoryMessageRepository();-->
<!--                        $aggregateRootRepository = new AggregateRootRepository(-->
<!--                            PersonalBudget::class,-->
<!--                            $messageRepository-->
<!--                        );-->

<!--                        $id = AggregateRootId::create();-->
<!--                        $headers = [Header::AGGREGATE_ROOT_ID => $id];-->
<!--                        $messageRepository->persist(-->
<!--                            new Message(new BudgetWasIncreased(100), $headers)-->
<!--                        );-->

<!--                        $budget = $aggregateRootRepository->retrieve($id);-->

<!--                        $budget->spend(150);-->

<!--                        $aggregateRootRepository->persist($budget);-->
<!--                        var_dump($messageRepository->lastCommit());-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#fff">-->
<!--                    <pre data-line="13" class="language-php"><code data-include="spend_150_includes.php" data-filename="spend_150.php" data-trim>-->
<!--                        $messageRepository = new InMemoryMessageRepository();-->
<!--                        $aggregateRootRepository = new AggregateRootRepository(-->
<!--                            PersonalBudget::class,-->
<!--                            $messageRepository-->
<!--                        );-->

<!--                        $id = AggregateRootId::create();-->
<!--                        $headers = [Header::AGGREGATE_ROOT_ID => $id];-->
<!--                        $messageRepository->persist(-->
<!--                            new Message(new BudgetWasIncreased(100), $headers)-->
<!--                        );-->

<!--                        $budget = $aggregateRootRepository->retrieve($id);-->

<!--                        $budget->spend(150);-->

<!--                        $aggregateRootRepository->persist($budget);-->
<!--                        var_dump($messageRepository->lastCommit());-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#fff">-->
<!--                    <pre data-line="15" class="language-php"><code data-include="spend_150_includes.php" data-filename="spend_150.php" data-trim>-->
<!--                        $messageRepository = new InMemoryMessageRepository();-->
<!--                        $aggregateRootRepository = new AggregateRootRepository(-->
<!--                            PersonalBudget::class,-->
<!--                            $messageRepository-->
<!--                        );-->

<!--                        $id = AggregateRootId::create();-->
<!--                        $headers = [Header::AGGREGATE_ROOT_ID => $id];-->
<!--                        $messageRepository->persist(-->
<!--                            new Message(new BudgetWasIncreased(100), $headers)-->
<!--                        );-->

<!--                        $budget = $aggregateRootRepository->retrieve($id);-->

<!--                        $budget->spend(150);-->

<!--                        $aggregateRootRepository->persist($budget);-->
<!--                        var_dump($messageRepository->lastCommit());-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#fff">-->
<!--                    <pre data-line="17" class="language-php"><code data-include="spend_150_includes.php" data-filename="spend_150.php" data-trim>-->
<!--                        $messageRepository = new InMemoryMessageRepository();-->
<!--                        $aggregateRootRepository = new AggregateRootRepository(-->
<!--                            PersonalBudget::class,-->
<!--                            $messageRepository-->
<!--                        );-->

<!--                        $id = AggregateRootId::create();-->
<!--                        $headers = [Header::AGGREGATE_ROOT_ID => $id];-->
<!--                        $messageRepository->persist(-->
<!--                            new Message(new BudgetWasIncreased(100), $headers)-->
<!--                        );-->

<!--                        $budget = $aggregateRootRepository->retrieve($id);-->

<!--                        $budget->spend(150);-->

<!--                        $aggregateRootRepository->persist($budget);-->
<!--                        var_dump($messageRepository->lastCommit());-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section data-background-color="#fff">-->
<!--                    <pre data-line="18" class="language-php"><code data-include="spend_150_includes.php" data-filename="spend_150.php" data-trim>-->
<!--                        $messageRepository = new InMemoryMessageRepository();-->
<!--                        $aggregateRootRepository = new AggregateRootRepository(-->
<!--                            PersonalBudget::class,-->
<!--                            $messageRepository-->
<!--                        );-->

<!--                        $id = AggregateRootId::create();-->
<!--                        $headers = [Header::AGGREGATE_ROOT_ID => $id];-->
<!--                        $messageRepository->persist(-->
<!--                            new Message(new BudgetWasIncreased(100), $headers)-->
<!--                        );-->

<!--                        $budget = $aggregateRootRepository->retrieve($id);-->

<!--                        $budget->spend(150);-->

<!--                        $aggregateRootRepository->persist($budget);-->
<!--                        var_dump($messageRepository->lastCommit());-->
<!--                    </code></pre>-->
<!--            </section>-->

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Given</span><br/>
                    A context<br/>
                    <span class="text-red">When</span><br/>
                    Input leads to a decision<br/>
                    <span class="text-red">Then</span><br/>
                    There is an outcome
                </blockquote>
            </section>

<!--            <section data-background-color="#3d4852">-->
<!--                <blockquote>-->
<!--                    <span class="text-red">Given</span><br/>-->
<!--                    Existing events<br/>-->
<!--                    <span class="text-red">When</span><br/>-->
<!--                    Input leads to a decision<br/>-->
<!--                    <span class="text-red">Then</span><br/>-->
<!--                    New events!-->
<!--                </blockquote>-->
<!--            </section>-->

            <section data-background-color="#fff">
                    <pre class="language-php"><code data-trim>
                        /**
                         * @test
                         */
                        public function it_allows_to_spend_within_the_budget()
                        {
                            $this->given(
                                new BudgetWasIncreased(100)
                            )->when(
                                new MakePurchase(40)
                            )->then(
                                new PurchaseWasMade(40)
                            );
                        }
                    </code></pre>
            </section>
<!--            <section data-background-color="#fff">-->
<!--                    <pre class="language-php"><code data-trim>-->
<!--                        /**-->
<!--                         * @test-->
<!--                         */-->
<!--                        public function it_disallows_to_spend_over_budget()-->
<!--                        {-->
<!--                            $id = $this->aggregateRootId();-->

<!--                            $this->given(-->
<!--                                new BudgetWasIncreased(100),-->
<!--                                new PurchaseWasMade(80)-->
<!--                            )->when(-->
<!--                                new MakePurchase($id, 40)-->
<!--                            )->expectToFail(-->
<!--                                new InsufficientFundsException()-->
<!--                            );-->
<!--                        }-->
<!--                    </code></pre>-->
<!--            </section>-->

<!--            <section>-->
<!--                <h2 class="text-red">When to apply this:</h2>-->
<!--                <h3>-->
<!--                    <ul>-->
<!--                        <li>Process modelling</li>-->
<!--                        <li>Auditing requirements</li>-->
<!--                        <li>Financial Transactions or Accounting</li>-->
<!--                    </ul>-->
<!--                </h3>-->
<!--            </section>-->

            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">Benefits</span><br/>
                    Push over pull (scale++)<br/>
                    High observability<br/>
                </blockquote>
            </section>
            <section data-background-color="#3d4852">
                <blockquote>
                    <span class="text-red">With Event Sourcing</span><br/>
                    Simple tasks are more work, but difficult tasks are easier.
                </blockquote>
            </section>
            <section>
                <h2 class="text-red">Additional benefits:</h2>
                <h3>
                    <ul>
                        <li>Super scalable</li>
                        <li>High observability</li>
                        <li>Insights on historical events</li>
                        <li>Aligns with Event Storming</li>
                    </ul>
                </h3>
            </section>

            <section>
                <h2>Down-sides</h2>
                <h3>
                <ul>
                    <li>Everything is recorded, and so are your failures.</li>
                    <li>Events outlive your model.</li>
                    <li>Events are everywhere.</li>
                    <li>Fewer people know about it.</li>
                </ul>
                </h3>
            </section>

            <section>
                <img src="static/logo.svg" width="240px" alt=""/>
                <h2>Event<span class="text-red">Sauce</span></h2>
                <h3>A pragmatic event<br/>sourcing library</h3>
            </section>

            <section>
                <h3>That is everything!</h3>
                <h2 class="text-red">Questions?</h2>
<!--                <h3>Thank you for your time.</h3>-->
            </section>

        </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
<!--    <script src="plugin/highlight/highlight.js_old"></script>-->
    <script src="plugin/prism/prism.js"></script>
<!--    <script src="plugin/execute/execute.js"></script>-->
    <script>
        // More info about initialization & config:
        // - https://revealjs.com/initialization/
        // - https://revealjs.com/config/
        Reveal.initialize({
            hash: true,
            center: true,
            progress: false,
            // disableLayout: true,

            transition: 'none',
            backgroundTransition: 'none',
            controls: false,
            // margin: -.10,
            // width: 1024, // add this in init or config
            // height: 768,
            // minScale: 0.5,
            // maxScale: 2.0,

            // Learn about plugins: https://revealjs.com/plugins/
            plugins: [ RevealMarkdown, RevealNotes, RevealPrism ]
        });
    </script>
</body>
</html>
